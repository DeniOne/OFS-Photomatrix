# План интеграции Telegram-бота с ERP-системой OFS-Photomatrix

## 1. Подготовка окружения

1. **Установка зависимостей**:
   ```bash
   # Создаем виртуальное окружение
   python -m venv venv
   
   # Активируем его (Windows)
   .\venv\Scripts\activate
   
   # Устанавливаем зависимости
   pip install -r requirements.txt
   ```

2. **Настройка конфигурации**:
   - Обновить `.env` файл:
     - Указать валидный `BOT_TOKEN` (7551929518:AAETdyi8z_hnfmEB7ki-VSAYiSkEJtu7jQM)
     - Указать правильный `API_URL` (например `http://localhost:8000/api/v1`)
     - Добавить `ADMIN_IDS` (telegram ID администраторов)

## 2. Разработка эндпоинтов на бэкенде

### 2.1 Эндпоинт для получения должностей

Согласно коду `api_client.py`, бот обращается к эндпоинту `/positions`, необходимо реализовать его на бэкенде:

```python
# В бэкенде (FastAPI)
@router.get("/positions", response_model=List[PositionSchema])
async def get_positions():
    positions = await position_service.get_positions()
    return positions
```

### 2.2 Эндпоинт для создания сотрудников

Бот обращается к эндпоинту `/staff` для создания сотрудников, необходимо реализовать этот эндпоинт:

```python
# В бэкенде (FastAPI)
@router.post("/staff", response_model=StaffSchema)
async def create_staff(staff_data: StaffCreateSchema):
    staff = await staff_service.create_staff(staff_data)
    return staff
```

### 2.3 Эндпоинт для валидации кодов приглашения

Необходимо реализовать эндпоинт для проверки и активации кодов:

```python
# В бэкенде (FastAPI)
@router.post("/auth/activate-code")
async def activate_invitation_code(data: InvitationCodeSchema):
    result = await auth_service.validate_and_activate_code(data.code, data.telegram_id)
    return result
```

## 3. Тестирование интеграции

1. **Запуск бота в тестовом режиме**:
   ```bash
   python main.py
   ```

2. **Тестовые сценарии**:
   - Запуск бота и проверка соединения с API
   - Проверка получения списка должностей
   - Тестовая регистрация сотрудника
   - Проверка создания сотрудника в основной системе
   - Проверка процесса активации кода

3. **Мониторинг**:
   - Просмотр логов бота для выявления ошибок
   - Мониторинг запросов к API

## 4. Внедрение в продакшн

1. **Установка бота на сервер**:
   - Клонирование репозитория
   - Настройка окружения
   - Настройка `.env` файла с продакшн-параметрами

2. **Запуск как службы**:
   - Использовать скрипт `deploy.ps1` для настройки бота как службы Windows
   - Запуск службы: `Start-Service TelegramBot`

3. **Мониторинг и обслуживание**:
   - Настроить регулярное резервное копирование данных бота
   - Настроить мониторинг состояния службы

## 5. Документирование

1. **Инструкция для пользователей**:
   - Как начать регистрацию через бота
   - Как активировать учетную запись

2. **Инструкция для администраторов**:
   - Как управлять заявками на регистрацию
   - Как генерировать коды приглашения
   - Как мониторить статус бота 